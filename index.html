<!DOCTYPE html>
<html>

<head>
    <title>spx client</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@4.x/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui" name="viewport">
    <meta charset="UTF-8">
    <style>
        #root {
            text-align: center;
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
            transition: 0.3s;
            padding: 2px 16px;
            font-size: 20px;
            margin: auto;
            min-width: 256px;
            max-width: 75%;
        }
        
        #root:hover {
            box-shadow: 0 8px 16px 0 rgba(0, 0, 0, 0.2);
        }
        
        a {
            color: rgb(0, 119, 170);
        }
        
        button {
            margin: 0.3em;
        }
        
        div.checkboxContainer {
            margin-top: 0.5em;
        }
        
        #articles {
            margin: 1em auto;
            font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
            font-size: 0.8em;
            border-collapse: collapse;
            table-layout: fixed;
            width: 80%;
            max-height: 30em;
            overflow-y: scroll;
            display: block;
        }
        
        #articles td,
        #articles th {
            border: 1px solid #ddd;
        }
        
        #articles tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        #articles tr:hover {
            background-color: #ddd;
        }
        
        #articles th:hover {
            background-color: #bbb;
        }
        
        #articles th {
            padding-top: 0.8em;
            padding-bottom: 0.8em;
            background-color: #b2b2b2;
            color: black;
        }
        
        /* Progress circle */
        
        .lds-facebook {
            display: inline-block;
            position: relative;
            width: 80px;
            height: 80px;
        }
        
        .lds-facebook div {
            display: inline-block;
            position: absolute;
            left: 8px;
            width: 16px;
            background: black;
            animation: lds-facebook 1.2s cubic-bezier(0, 0.5, 0.5, 1) infinite;
        }
        
        .lds-facebook div:nth-child(1) {
            left: 8px;
            animation-delay: -0.24s;
        }
        
        .lds-facebook div:nth-child(2) {
            left: 32px;
            animation-delay: -0.12s;
        }
        
        .lds-facebook div:nth-child(3) {
            left: 56px;
            animation-delay: 0;
        }
        
        @keyframes lds-facebook {
            0% {
                top: 8px;
                height: 64px;
            }
            
            50%,
            100% {
                top: 24px;
                height: 32px;
            }
        }
    </style>
</head>

<body>
<div id="root">
    <input v-model="input.url" placeholder="Article URL" style="width: 512px; max-width: 100%;" type="text"/><br/>
    <input v-model="input.translator" placeholder="Translator" type="text"/><br/>
    <input id="request" style="display: none;" type="button" value="Request"/>
    <div id="output"></div>
    <input id="read" style="display: none;" type="button" value="Clear"/>
    <div id="progressBar" :style="{display: loading.filters ? 'block' : 'none'}" class="lds-facebook">
        <div></div>
        <div></div>
        <div></div>
    </div>
    <div>
        <h1>Bug Translators</h1>
        <div id="colorsPreview"></div>
    </div>
    <div id="filters" :style="{display: !loading.filters ? 'block' : 'none'}">
        <h1>Filters</h1>
        <div class="checkboxContainer">
            <v-radio-group row>
                <v-checkbox v-for="item in categories" v-model="checkboxes[item]" :label="item.toUpperCase()" dense
                            hide-details></v-checkbox>
            </v-radio-group>
        </div>
        <div class="checkboxContainer">
            <v-radio-group row>
                <v-checkbox v-for="item in artCategories" v-model="artCheckboxes[item]" :label="item.toUpperCase()"
                            dense
                            hide-details></v-checkbox>
            </v-radio-group>
        </div>
        <div class="checkboxContainer">
            <v-radio-group row>
                <v-checkbox v-model="status.translated" dense hide-details label="Translated"></v-checkbox>
                <v-checkbox v-model="status.untranslated" dense hide-details label="Untranslated"></v-checkbox>
                <v-checkbox v-model="status.emeralded" dense hide-details label="Emeralded"></v-checkbox>
                <v-checkbox v-model="status.unemeralded" dense hide-details label="Unemeralded"></v-checkbox>
            </v-radio-group>
        </div>
    </div>
    <div>
        <h1>Articles</h1>
        <v-simple-table>
            <template v-slot:default>
            <thead>
            <tr>
                <th>Time</th>
                <th>Category</th>
                <th>Origin</th>
                <th>Translation</th>
                <th>Status</th>
                <th>Take</th>
            </tr>
            </thead>
            <tbody>
            <tr v-for="item in filteredArticles">
                <td>{{item.time}}</td>
                <td>{{item.category}}</td>
                <td><a :href="item.link" target="_blank">{{item.title}}</a></td>
                <td><a v-if="item.isTranslated" :href="item.trLink" target="_blank">{{item.trTitle}}</a>
                <span v-else>N/A</span></td>
                <td>
                    <img src="https://user-images.githubusercontent.com/15277496/76684841-320b4a80-65dd-11ea-8206-e766bbbd3b7d.png" v-if="item.isEmeralded">
                    <img v-else src="https://user-images.githubusercontent.com/15277496/76684847-3c2d4900-65dd-11ea-8d91-c7be623cf3d2.png">
                </td>
                <td>
                    <button>{{item.operationEmoji}}</button>
                </td>
            </tr>
            </tbody>
            </template>
        </v-simple-table>
    </div>
</div>
<p style="text-align: center;"><a href="https://github.com/SPGoding/spx/blob/master/README.md">ABOUT US</a> &
    <a href="https://github.com/SPGoding/spx/blob/master/PRIVACY_POLICY.md">PRIVACY POLICY</a></p>
<script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.js"></script>
<script type="text/javascript">
    "use strict"
    const read = document.getElementById('read')
    const request = document.getElementById('request')
    const output = document.getElementById('output')
    const status = document.getElementById('status')
    const articlesTable = document.getElementById('articles')
    const colorsPreview = document.getElementById('colorsPreview')
    const categoryCheckboxes = document.getElementById('categoryCheckboxes')
    const artCategoryCheckboxes = document.getElementById('artCategoryCheckboxes')
    const showTranslatedArticle = document.getElementById('showTranslatedArticle')
    const showUntranslatedArticle = document.getElementById('showUntranslatedArticle')
    const showEmeraldedArticle = document.getElementById('showEmeraldedArticle')
    const showUnemeraldedArticle = document.getElementById('showUnemeraldedArticle')
    const progressBar = document.getElementById('progressBar')
    const filters = document.getElementById('filters')
    const wsURL = 'wss://%replace_as_ws_url%'
    const webSocket = new WebSocket(wsURL)
    
    const MiscArtCategory = '其他'
    
    let hasWebSocketDone = false
    let hasArticlesDone = false
    let hasRequestDone = true
    
    const clipboardJS = new ClipboardJS('.copy')
    
    request.onclick = () => {
        if (url.value) {
            hasRequestDone = false
            progressBar.style.display = ''
            if (url.value.startsWith('verify ')) {
                localStorage.setItem('lastRequest', url.value)
                webSocket.send(`request, ${url.value}`)
                url.value = ''
            } else if (url.value.startsWith('MC-')) {
                webSocket.send(`request, ${url.value}`)
                url.value = ''
            } else {
                webSocket.send(`request, ${url.value} ${translator.value}`)
                url.value = ''
            }
            localStorage.setItem('translator', translator.value)
        } else {
            alert('Please input URI')
        }
    }
    
    read.onclick = () => {
        output.innerHTML = ''
        read.style.display = 'none'
    }
    
    webSocket.onopen = () => {
        request.style.display = ''
        hasWebSocketDone = true
        hideProgressBar()
    }
    
    webSocket.onmessage = event => {
        const json = JSON.parse(event.data)
        let append = ''
        let playSound = false
        switch (json.type) {
            case 'version':
                append = `VERSION - ${json.value.id}`
                playSound = true
                break
            case 'colors':
                const colors = json.value
                const usernames = Object.keys(colors).sort()
                const resultPreviewArr = []
                const resultBBCodeArr = []
                for (const u of usernames) {
                    resultPreviewArr.push(`<span style="color:${colors[u].color};">${u}</span>`)
                    resultBBCodeArr.push(`[color=${colors[u].color}]${u}[/color]`)
                }
                colorsPreview.innerHTML = `${resultPreviewArr.join('、')}<br><code style="font-size:0.6em;">${resultBBCodeArr.join('、')}</code>`;
                return
            case 'bbcode':
                hasRequestDone = true
                hideProgressBar()
                append = `BBCode - <a href="${json.value.id}" target="_blank">${json.value.text}</a>`
                break
            case 'read':
                hasRequestDone = true
                hideProgressBar()
                output.innerHTML = ""
                read.style.display = 'none'
                return
            case 'verify':
                hasRequestDone = true
                hideProgressBar()
                if (json.value.id === 'owner') {
                    translator.style.color = 'gold'
                    translator.style.fontWeight = 'bold'
                } else {
                    translator.style.color = 'green'
                    translator.style.fontWeight = 'bold'
                }
                return
            default:
                hasRequestDone = true
                hideProgressBar()
                append = `${json.type.toUpperCase()} - <a href="${json.value.id}" target="_blank">${json.value.text}</a>`
                break
        }
        if (playSound) {
            const speech = `New ${json.type.replace(/_/g, ' ')} detected: ${json.value.text}`
            speechSynthesis.speak(new SpeechSynthesisUtterance(speech))
        }
        if (json.value.addition) {
            append += ` - <button class="copy" data-clipboard-text="${
                json.value.addition
                    .replace(/\</g, '&lt;')
                    .replace(/&/g, '&amp;')
                    .replace(/"/g, '&#39;')
            }">Copy BBCode</button>`
        }
        output.innerHTML = `${append}<br />${output.innerHTML}`
        read.style.display = ''
    }
    
    function requestBBCodeFor(link) {
        url.value = link
        request.onclick()
    }
    
    function hideProgressBar() {
        if (hasArticlesDone && hasWebSocketDone) {
            progressBar.style.display = 'none'
        }
    }
    
    function updateArticlesView() {
        setTimeout(() => {
            let innerHTML = '<table id="articles"><tr><th>Time</th><th>Category</th><th>Origin</th><th>Translation</th><th>Status</th><th>Take</th></tr>'
            
            const filteredTranslated = [
                ...!showTranslatedArticle.classList.contains('unchecked') ? [true] : [],
                ...!showUntranslatedArticle.classList.contains('unchecked') ? [false] : []
            ]
            
            const filteredEmeralded = [
                ...!showEmeraldedArticle.classList.contains('unchecked') ? [true] : [],
                ...!showUnemeraldedArticle.classList.contains('unchecked') ? [false] : []
            ]
            
            for (const [time, title, link, trTitle, trLink, _, emeralded, cat] of articles) {
                const isEmeralded = emeralded === '1'
                const isTranslated = trLink !== '-'
                
                const [category, artCategory] = cat.split(':')
                
                let operationEmoji
                if (isEmeralded) {
                    operationEmoji = '🖤'
                } else if (isTranslated) {
                    operationEmoji = '💚'
                } else {
                    operationEmoji = '💝'
                }
                
                innerHTML += '<tr>'
                innerHTML += `<td>${time}</td>`
                innerHTML += `<td>${cat.toUpperCase()}</td>`
                innerHTML += `<td><a href="${link}" target="_blank">${title}</a></td>`
                innerHTML += `<td>${isTranslated ? `<a href="${trLink}" target="_blank">${trTitle}</a>` : 'N/A'}</td>`
                innerHTML += `<td><img src="${isEmeralded ? 'https://user-images.githubusercontent.com/15277496/76684841-320b4a80-65dd-11ea-8206-e766bbbd3b7d.png' : 'https://user-images.githubusercontent.com/15277496/76684847-3c2d4900-65dd-11ea-8d91-c7be623cf3d2.png'}"></td>`
                innerHTML += `<td><button type="button" onclick="requestBBCodeFor('${link}')">${operationEmoji}</button></td>`
                innerHTML += '</tr>'
            }
            
            innerHTML += '</table>'
            
            articlesTable.innerHTML = innerHTML
            hideProgressBar()
            filters.style.display = ''
        }, 0)
    }
    
    webSocket.onerror = e => {
        console.error(e)
    }
    
    webSocket.onclose = () => {
        read.style.display = 'none'
        request.style.display = 'none'
        url.disabled = true
    }
    
    Vue.config.devtools = true
    new Vue({
        el: '#root',
        vuetify: new Vuetify(),
        mounted() {
            this.getArticles()
        },
        beforeMount() {
            if (localStorage.getItem('lastRequest')) {
                this.input.url.value = localStorage.getItem('lastRequest')
            }
            if (localStorage.getItem('translator')) {
                this.input.translator.value = localStorage.getItem('translator')
            }
        },
        computed: {
            filteredArticles(){
                let categories = Object.keys(this.checkboxes).filter(v => this.checkboxes[v])
                let artCategories = Object.keys(this.artCheckboxes).filter(v => this.artCheckboxes[v])
                let result = this.articles.map(v => {
                    const [time, title, link, trTitle, trLink,,emeralded, cat] = v
                    const isEmeralded = emeralded === '1'
                    const isTranslated = trLink !== '-'
    
                    const [category, artCategory] = cat.split(':')
                    let emeraldedMatch = isEmeralded ? this.status.emeralded : this.status.unemeralded
                    let translatedMatch = isTranslated ? this.status.translated : this.status.untranslated
                    if(!(categories.includes(category) && artCategories.includes(artCategory || MiscArtCategory) && emeraldedMatch && translatedMatch)){
                        return null
                    }
                    let operationEmoji
                    if (isEmeralded) {
                        operationEmoji = '🖤'
                    } else if (isTranslated) {
                        operationEmoji = '💚'
                    } else {
                        operationEmoji = '💝'
                    }
                    
                    return {
                        operationEmoji,
                        time,
                        category: cat.toUpperCase(),
                        link,
                        title,
                        trLink,
                        trTitle,
                        isTranslated,
                        isEmeralded
                    }
                }).filter(v => v!= null)
                console.log(result)
                return result
            }
        },
        methods: {
            getArticles() {
                const xhr = new XMLHttpRequest()
                xhr.open('GET', 'https://raw.githubusercontent.com/RicoloveFeng/minecraft.net-translations/master/rawtable.csv', true)
                xhr.onreadystatechange = () => {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            let articles = [], categories = [], artCategories = []
                            const rows = xhr.responseText.split(/\r?\n/).slice(1, -1)
                            for (const row of rows) {
                                // https://stackoverflow.com/questions/21105360/regex-find-comma-not-inside-quotes/21106122
                                const cols = row.split(/(?!\B"[^"]*),(?![^"]*"\B)/)
                                const [category, artCategory] = cols[7].split(':')
                                if (!categories.includes(category)) {
                                    categories.push(category)
                                }
                                if (!artCategories.includes(artCategory || MiscArtCategory)) {
                                    artCategories.push(artCategory || MiscArtCategory)
                                }
                                articles.push(cols)
                            }
                            hasArticlesDone = true
                            this.articles = articles
                            this.categories = categories
                            this.artCategories = artCategories
                            this.checkboxes = categories.reduce((data, obj) => {
                                data[obj] = true
                                return data
                            }, {})
                            this.artCheckboxes = artCategories.reduce((data, obj) => {
                                data[obj] = true
                                return data
                            }, {})
                            this.loading.filters = false
                        } else {
                            alert(`博文录加载失败，错误代码：${xhr.status}`)
                        }
                    }
                }
                xhr.send()
            }
        },
        data() {
            return {
                articles: [],
                categories: [],
                artCategories: [],
                loading: {
                    filters: true
                },
                input: {
                    url: '',
                    translator: ''
                },
                checkboxes: {},
                artCheckboxes: {},
                status: {
                    translated: true,
                    untranslated: true,
                    unemeralded: true,
                    emeralded: true
                }
            }
        }
    })
</script>

</body>

</html>
