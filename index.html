<!DOCTYPE html>
<html>

<head>
    <title>spx client</title>
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font@4.x/css/materialdesignicons.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui" name="viewport">
    <meta charset="UTF-8">
    <style>
        #root {
            text-align: center;
            box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2);
            transition: 0.3s;
            padding: 2px 16px;
            font-size: 20px;
            margin: auto;
            min-width: 256px;
            max-width: 75%;
        }
        
        #root:hover {
            box-shadow: 0 8px 16px 0 rgba(0, 0, 0, 0.2);
        }
        
        a {
            color: rgb(0, 119, 170);
        }
        
        button {
            margin: 0.3em;
        }
        
        div.checkboxContainer {
            margin-top: 0.5em;
        }
        
        #articles {
            margin: 1em auto;
            font-family: "Trebuchet MS", Arial, Helvetica, sans-serif;
            font-size: 0.8em;
            border-collapse: collapse;
            table-layout: fixed;
            width: 80%;
            max-height: 30em;
            overflow-y: scroll;
            display: block;
        }
        
        #articles td,
        #articles th {
            border: 1px solid #ddd;
        }
        
        #articles tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        #articles tr:hover {
            background-color: #ddd;
        }
        
        #articles th:hover {
            background-color: #bbb;
        }
        
        #articles th {
            padding-top: 0.8em;
            padding-bottom: 0.8em;
            background-color: #b2b2b2;
            color: black;
        }
        
        /* Progress circle */
        
        .lds-facebook {
            display: inline-block;
            position: relative;
            width: 80px;
            height: 80px;
        }
        
        .lds-facebook div {
            display: inline-block;
            position: absolute;
            left: 8px;
            width: 16px;
            background: black;
            animation: lds-facebook 1.2s cubic-bezier(0, 0.5, 0.5, 1) infinite;
        }
        
        .lds-facebook div:nth-child(1) {
            left: 8px;
            animation-delay: -0.24s;
        }
        
        .lds-facebook div:nth-child(2) {
            left: 32px;
            animation-delay: -0.12s;
        }
        
        .lds-facebook div:nth-child(3) {
            left: 56px;
            animation-delay: 0;
        }
        
        @keyframes lds-facebook {
            0% {
                top: 8px;
                height: 64px;
            }
            
            50%,
            100% {
                top: 24px;
                height: 32px;
            }
        }
    </style>
</head>

<body>
<div id="root">
    <input v-model="input.url" :disabled="loading.websocket" placeholder="Article URL" style="width: 512px; max-width: 100%;"
           type="text"/><br/>
    <input v-model="input.translator" :style="translatorStyle" placeholder="Translator" type="text"/><br/>
    <input id="request" :style="{display: loading.websocket ? 'none' : 'block' }" type="button" value="Request"
           @click="request"/>
    <div id="output">
        <div v-html="output.append"></div>
        <button v-if="output.value" @click="navigator.clipboard.writeText(output.value)">Copy BBCode</button>
    </div>
    <input id="read" :style="{display: showRead? 'block' : 'none'}" type="button" value="Clear" @click="clear"/>
    <div id="progressBar" :style="{display: loading.filters ? 'block' : 'none'}" class="lds-facebook">
        <div></div>
        <div></div>
        <div></div>
    </div>
    <div>
        <h1>Bug Translators</h1>
        <div id="colorsPreview">
            <span v-for="item in colorsPreview" :style="{color: item.c}">{{ item.u }}&nbsp;</span>
            <code>{{ colorsPreview.map(v => `[color=${v.c}]${v.u}[/color]`).join("、") }}</code>
        </div>
    </div>
    <div id="filters" :style="{display: !loading.filters ? 'block' : 'none'}">
        <h1>Filters</h1>
        <div class="checkboxContainer">
            <v-radio-group row>
                <v-checkbox v-for="item in categories" v-model="checkboxes[item]" :label="item.toUpperCase()" dense
                            hide-details></v-checkbox>
            </v-radio-group>
        </div>
        <div class="checkboxContainer">
            <v-radio-group row>
                <v-checkbox v-for="item in artCategories" v-model="artCheckboxes[item]" :label="item.toUpperCase()"
                            dense
                            hide-details></v-checkbox>
            </v-radio-group>
        </div>
        <div class="checkboxContainer">
            <v-radio-group row>
                <v-checkbox v-model="status.translated" dense hide-details label="Translated"></v-checkbox>
                <v-checkbox v-model="status.untranslated" dense hide-details label="Untranslated"></v-checkbox>
                <v-checkbox v-model="status.emeralded" dense hide-details label="Emeralded"></v-checkbox>
                <v-checkbox v-model="status.unemeralded" dense hide-details label="Unemeralded"></v-checkbox>
            </v-radio-group>
        </div>
    </div>
    <div>
        <h1>Articles</h1>
        <v-simple-table>
            <template v-slot:default>
                <thead>
                <tr>
                    <th>Time</th>
                    <th>Category</th>
                    <th>Origin</th>
                    <th>Translation</th>
                    <th>Status</th>
                    <th>Take</th>
                </tr>
                </thead>
                <tbody>
                <tr v-for="item in filteredArticles">
                    <td>{{ item.time }}</td>
                    <td>{{ item.category }}</td>
                    <td><a :href="item.link" target="_blank">{{ item.title }}</a></td>
                    <td><a v-if="item.isTranslated" :href="item.trLink" target="_blank">{{ item.trTitle }}</a>
                        <span v-else>N/A</span></td>
                    <td>
                        <img
                            v-if="item.isEmeralded"
                            src="https://user-images.githubusercontent.com/15277496/76684841-320b4a80-65dd-11ea-8206-e766bbbd3b7d.png">
                        <img v-else
                             src="https://user-images.githubusercontent.com/15277496/76684847-3c2d4900-65dd-11ea-8d91-c7be623cf3d2.png">
                    </td>
                    <td>
                        <button @click="requestBBCodeFor(item.link)"><a :style="{color: item.operationColor}">
                            <svg style="width:24px;height:24px" viewBox="0 0 24 24">
                                <path d="M12,21.35L10.55,20.03C5.4,15.36 2,12.27 2,8.5C2,5.41 4.42,3 7.5,3C9.24,3 10.91,3.81 12,5.08C13.09,3.81 14.76,3 16.5,3C19.58,3 22,5.41 22,8.5C22,12.27 18.6,15.36 13.45,20.03L12,21.35Z"
                                      fill="currentColor"/>
                            </svg>
                        </a></button>
                    </td>
                </tr>
                </tbody>
            </template>
        </v-simple-table>
    </div>
</div>
<p style="text-align: center;"><a href="https://github.com/SPGoding/spx/blob/master/README.md">ABOUT US</a> &
    <a href="https://github.com/SPGoding/spx/blob/master/PRIVACY_POLICY.md">PRIVACY POLICY</a></p>
<script src="https://cdn.jsdelivr.net/npm/vue@2.x/dist/vue.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.js"></script>
<script type="text/javascript">
    "use strict"
    const colorsPreview = document.getElementById('colorsPreview')
    const wsURL = 'wss://%replace_as_ws_url%'
    const webSocket = new WebSocket(wsURL)
    
    const MiscArtCategory = '其他'
    
    Vue.config.devtools = true
    new Vue({
        el: '#root',
        vuetify: new Vuetify(),
        mounted() {
            this.getArticles()
            
            
            webSocket.onopen = () => {
                console.log('onopen')
                this.loading.websocket = false
            }
            
            webSocket.onmessage = event => {
                const json = JSON.parse(event.data)
                let append = ''
                let playSound = false
                switch (json.type) {
                    case 'version':
                        append = `VERSION - ${json.value.id}`
                        playSound = true
                        break
                    case 'colors':
                        const colors = json.value
                        const usernames = Object.keys(colors).sort()
                        const resultPreviewArr = []
                        for (const u of usernames) {
                            resultPreviewArr.push({
                                c: colors[u].color,
                                u
                            })
                        }
                        this.colorsPreview = resultPreviewArr
                        return
                    case 'bbcode':
                        append = `BBCode - <a href="${json.value.id}" target="_blank">${json.value.text}</a>`
                        break
                    case 'read':
                        this.output.append = ""
                        this.output.value = ""
                        this.showRead = false
                        return
                    case 'verify':
                        if (json.value.id === 'owner') {
                            this.translatorStyle = {
                                color: 'gold',
                                fontWeight: 'bold'
                            }
                        } else {
                            this.translatorStyle = {
                                color: 'green',
                                fontWeight: 'bold'
                            }
                        }
                        return
                    default:
                        append = `${json.type.toUpperCase()} - <a href="${json.value.id}" target="_blank">${json.value.text}</a>`
                        break
                }
                if (playSound) {
                    const speech = `New ${json.type.replace(/_/g, ' ')} detected: ${json.value.text}`
                    speechSynthesis.speak(new SpeechSynthesisUtterance(speech))
                }
                if (json.value.addition) {
                    this.output.value =
                        json.value.addition
                            .replace(/\</g, '&lt;')
                            .replace(/&/g, '&amp;')
                            .replace(/"/g, '&#39;')
                }
                this.output.append = append
                this.showRead = true
            }
            
            webSocket.onerror = e => {
                console.error(e)
            }
            
            webSocket.onclose = () => {
                console.log('onclose')
                this.showRead = false
                this.loading.websocket = true
            }
            
        },
        watch: {
            'input.url'(d) {
                localStorage.setItem("lastRequest", d)
            },
            'input.translator'(d) {
                localStorage.setItem("translator", d)
            }
        },
        beforeMount() {
            if (localStorage.getItem('lastRequest')) {
                this.input.url = localStorage.getItem('lastRequest')
            }
            if (localStorage.getItem('translator')) {
                this.input.translator = localStorage.getItem('translator')
            }
        },
        computed: {
            filteredArticles() {
                let categories = Object.keys(this.checkboxes).filter(v => this.checkboxes[v])
                let artCategories = Object.keys(this.artCheckboxes).filter(v => this.artCheckboxes[v])
                let result = this.articles.map(v => {
                    const [time, title, link, trTitle, trLink, , emeralded, cat] = v
                    const isEmeralded = emeralded === '1'
                    const isTranslated = trLink !== '-'
                    
                    const [category, artCategory] = cat.split(':')
                    let emeraldedMatch = isEmeralded ? this.status.emeralded : this.status.unemeralded
                    let translatedMatch = isTranslated ? this.status.translated : this.status.untranslated
                    if (!(categories.includes(category) && artCategories.includes(artCategory || MiscArtCategory) && emeraldedMatch && translatedMatch)) {
                        return null
                    }
                    let operationColor
                    if (isEmeralded) {
                        operationColor = 'black'
                    } else if (isTranslated) {
                        operationColor = 'green'
                    } else {
                        operationColor = 'red'
                    }
                    
                    return {
                        operationColor,
                        time,
                        category: cat.toUpperCase(),
                        link,
                        title,
                        trLink,
                        trTitle,
                        isTranslated,
                        isEmeralded
                    }
                }).filter(v => v != null)
                console.log(result)
                return result
            }
        },
        methods: {
            requestBBCodeFor(link) {
                this.request(link)
            },
            clear() {
                this.output.append = ""
                this.output.value = ""
                this.showRead = false
            },
            request(url) {
                const val = url || this.input.url
                if (val) {
                    if (val.startsWith('verify ')) {
                        localStorage.setItem('lastRequest', val)
                        webSocket.send(`request, ${val}`)
                        this.input.url = ''
                    } else if (val.startsWith('MC-')) {
                        webSocket.send(`request, ${val}`)
                        this.input.url = ''
                    } else {
                        webSocket.send(`request, ${val} ${this.input.translator}`)
                        this.input.url = ''
                    }
                    localStorage.setItem('translator', this.input.translator)
                } else {
                    alert('Please input URI')
                }
            },
            getArticles() {
                const xhr = new XMLHttpRequest()
                xhr.open('GET', 'https://raw.githubusercontent.com/RicoloveFeng/minecraft.net-translations/master/rawtable.csv', true)
                xhr.onreadystatechange = () => {
                    if (xhr.readyState === 4) {
                        if (xhr.status === 200) {
                            let articles = [], categories = [], artCategories = []
                            const rows = xhr.responseText.split(/\r?\n/).slice(1, -1)
                            for (const row of rows) {
                                // https://stackoverflow.com/questions/21105360/regex-find-comma-not-inside-quotes/21106122
                                const cols = row.split(/(?!\B"[^"]*),(?![^"]*"\B)/)
                                const [category, artCategory] = cols[7].split(':')
                                if (!categories.includes(category)) {
                                    categories.push(category)
                                }
                                if (!artCategories.includes(artCategory || MiscArtCategory)) {
                                    artCategories.push(artCategory || MiscArtCategory)
                                }
                                articles.push(cols)
                            }
                            this.articles = articles
                            this.categories = categories
                            this.artCategories = artCategories
                            this.checkboxes = categories.reduce((data, obj) => {
                                data[obj] = true
                                return data
                            }, {})
                            this.artCheckboxes = artCategories.reduce((data, obj) => {
                                data[obj] = true
                                return data
                            }, {})
                            this.loading.filters = false
                        } else {
                            alert(`博文录加载失败，错误代码：${xhr.status}`)
                        }
                    }
                }
                xhr.send()
            }
        },
        data() {
            return {
                articles: [],
                categories: [],
                artCategories: [],
                loading: {
                    filters: true,
                    websocket: true
                },
                input: {
                    url: '',
                    translator: ''
                },
                checkboxes: {},
                artCheckboxes: {},
                status: {
                    translated: true,
                    untranslated: true,
                    unemeralded: true,
                    emeralded: true
                },
                colorsPreview: [],
                output: {
                    append: '',
                    value: ''
                },
                translatorStyle: {
                    color: 'black',
                    fontWeight: 'normal'
                },
                showRead: false
            }
        }
    })
</script>

</body>

</html>
